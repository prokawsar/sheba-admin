<div class="page-content">
  <PageTitle page="{page}">
    <a class="button is-info is-pulled-right" href="#prescriptions">
      <Icon icon="long-arrow-left" size="small" />
      <span>Back to All Prescriptions</span>
    </a>
  </PageTitle>

  <ViewScaffold {is_loading} {is_error} {error_message}>

    {#if tracker.error}
    <Notification type="danger"> {error_message} </Notification>
    {/if}
    
    <Panel title="Prescription Details" has_toolbar={true} >

      <div class="columns">
        <div class="column">
        {#if data.patient}
        <p class="title is-5">Patient Details</p>

        <PatientDetails data={data.patient} />
        {/if}
        </div>
        <div class="column">
          <div class="columns">

            <div class="column">        
              <p class="title is-5">Current Remedy
                <span class="is-pulled-right">
                  <button class="button is-primary" type="button">Add More</button>
                </span>
              </p>

              <Timeline history="{treatments}" />

              <!-- <table class="table has-background-warning-light">
                <tr>
                  <th>Remedy name</th>
                  <th>Power</th>
                  <th>Taking Rule</th>
                  <th>Quantity</th>
                  <th></th>
                </tr>
                {#each treatments as {remedy, power, taking_rule}, i}
                  <tr>
                    <td>{remedy}</td>
                    <td>{power}</td>
                    <td>{taking_rule}</td>
                    <td></td>
                    <td></td>
                  </tr>
                {/each}
              </table> -->
            </div>
          </div>
        
        </div>
      </div>
    </Panel>
    
  </ViewScaffold>
</div>

<script>
  import Model from '../../../models/histories';
  import Remedies from '../../../models/remedies';
  import {Icon, Notification, Panel, Message} from '@kws3/helpers';
  import { SubmitButton, ConfirmButton } from '@kws3/buttons';
  import Router from '../../../services/router';
  import SearchableSelect from '@kws3/searchable-select';
  import PatientDetails from '../helpers/PatientDetails.html';
  import Timeline from '../helpers/Timeline.html';
  
  export default {
    components: {
      ViewScaffold: '../../helpers/ViewScaffold.html',
      PageTitle: '../../helpers/PageTitle.html',
      Notification, Message, SearchableSelect, SubmitButton, ConfirmButton,
      Icon, Panel, PatientDetails, Timeline

    },
    data() {
      return {
        is_loading: false,
        is_error: false,
        error_message: '',
        selected_symptom: '',
        selected_symp: '',
        selected_keyed_symp: '',
        result_symptoms: '',
        remedies: {},
        data: {},
        meta: {},
        remedy_found: {},
        omitted_field: [ 'id', 'name', 'created', 'modified', 'deleted', 'patient', 'treatments'],
        tracker: {
          saving: false,
          saved: false,
          error: false,
        },
        page: {
          title: 'View Prescription',
          subtitle: 'Patients prescription details',
          icon: 'building-o',
          icon_badge: 'pencil'
        },
      }
    },
    computed: {
      entityId: ({ $nav }) => $nav && $nav.params[0],
      filterFields: ({remedies, omitted_field}) => {
        
        let last = ['built', 'constitution', 'diathesis', 'miasm', 'temperament', 'temperature_and_weather',
        'thermal_sensitivity', 'sensation', 'tendency_take_cold', 'desires', 'aversions', 'birth_history_milestones',
        'tissues', 'stages_and_states', 'attacks_and_side', 'ailments_from', 'affections', 'clinical', 'modalities',
        'mental_state_and_disorders', 'appearance_and_behavior', 'attention_and_concentration', 'expression',
        'consciousness', 'mood_and_affect', 'memory', 'speech', 'thoughts_and_ideas', 'perception', 'intelligence',
        'judgment', 'fear_and_live_alone', 'boring', 'peaceful', 'anger', 'hobby', 'habit', 'addiction', 'nutrition',
        'anaemia', 'cyanosis', 'dehydration', 'jaundice', 'pulse', 'breathing', 'peculiar_rare_symptoms'
        ];

        let filtered = [];
        if(remedies.length){
          for(let [key, value] of Object.entries(remedies[0])) {
            if( !last.includes(key) && !omitted_field.includes(key)){
              filtered.push(key)
            }
          }
          filtered.push(...last)
          return filtered
        }
      },
      treatments: ({data}) => {
        if(data.treatments){
          let values = data.treatments;
          // this gives an object with dates as keys
          const groups = values.reduce((groups, remedy) => {
            const date = remedy.created;
            if (!groups[date]) {
              groups[date] = [];
            }
            groups[date].push(remedy);
            return groups;
          }, {});

          // Edit: to add it in the array format instead
          const groupArrays = Object.keys(groups).map((date) => {
            return {
              date,
              remedies: groups[date]
            };
          });

          return groupArrays
        }
        return []
      }
      
    },
    oncreate() {
      var { entityId } = this.get();
      this.load();
      this.loadRemedies();
    },
    methods: {
      
      select_symptom(key){
        this.set({ selected_symptom: key })
      },
      load() {
        var { entityId } = this.get();

        this.set({
          is_loading: true,
          is_error: false
        });

        Model && Model.getOne(entityId)
        .then((r) => {
          console.log(r)
          this.set({
            is_loading: false,
            meta: r._meta,
            data: r.response
          });

        })
        .catch((r) => {
          var user_message = '';
          if (typeof r != 'undefined' && typeof r.response != 'undefined' && typeof r.response.records != 'undefined') {
            user_message = r.response.records.userMessage;
          }
          this.set({
            'is_error': true,
            'is_loading': false,
            'error_message': user_message
          });
        });
      },
      loadRemedies(){
        Remedies.getAll({limit:1000})
        .then( (r) => {
          this.set({ remedies: r.response })
        })
        .catch( (r) => {
          console.log(r)
        })
      },
      save() {
        var {data, entityId, tracker} = this.get();

        this.set({
          tracker: {
            saving: true,
            saved: false,
            error: false
          }
        });

        Model.save(entityId, data)
        .then(r => {
          this.set({
            data: r.response,
            tracker: {
              saving: false,
              saved: true,
              error: false
            }
          });

          setTimeout(() => {
            tracker.saved = false;
            this.set({tracker});
          }, 1500);
        })
        .catch(r => {
          console.log(r)
          this.set({error_message: 'There was an error updating premise'});

          this.set({
            tracker: {
              saving: false,
              saved: false,
              error: true
            }
          });

          setTimeout(() => {
            this.set({tracker: {error: false}});
          }, 1500);
        });
      }
    }
  }
</script>